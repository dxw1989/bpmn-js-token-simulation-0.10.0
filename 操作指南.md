# bpmn-js Token Simulation 操作指南（v2）

本指南面向需要二次开发或深度集成 Token Simulation 插件的工程师，详细说明 `lib/` 目录下核心服务、特性模块与事件 API 的行为与用法。

## 1. 模块总览与注入关系

插件通过 bpmn-js 的依赖注入系统注册各个模块，`lib/modeler.js` 同时列出了模型器模式下初始化顺序与服务名称。下表展示了关键 token 与其实现文件，便于在自定义 bundle 中按需裁剪或替换：

| 注入 token | 对应实现 | 作用概述 |
| --- | --- | --- |
| `animation` | `lib/animation/Animation` | 负责绘制、驱动并控制流程令牌动画。 |
| `contextPads` | `lib/features/context-pads` | 在模拟模式下为特定 BPMN 元素挂载上下文操作。 |
| `tokenSimulationBehavior` | `lib/features/token-simulation-behavior` | 注册 BPMN 元素的令牌生成/消费处理器。 |
| `processInstances` / `processInstanceIds` / `processInstanceSettings` | `lib/features/process-*` | 维护流程实例 ID、层级关系及可视化显示策略。 |
| `tokenSimulationPalette`、`pauseSimulation`、`resetSimulation`、`log` 等 | `lib/features/*` | 构建模拟控制面板及相关 UI。 |
| `simulationState`、`elementNotifications`、`tokenCount` | `lib/features/*` | 追踪流程状态并呈现可视化提示。 |
| `toggleMode`、`disableModeling`、`tokenSimulationKeyboardBindings` | `lib/features/*` | 负责模式切换、建模只读化与快捷键处理。 |

以上 token 均在 `__init__` 数组中声明，保证在插件启用时自动实例化。 【F:lib/modeler.js†L1-L49】

## 2. 事件总线与工具方法

### 2.1 事件枚举

插件所有内部通讯均通过 EventBus 广播，事件名称集中定义在 `EventHelper` 中，可在宿主应用内监听或派发以扩展行为：

- `toggleMode`、`generateToken`、`consumeToken`、`playSimulation`、`pauseSimulation`、`resetSimulation`、`terminateEvent`
- `processInstanceCreated`、`processInstanceFinished`、`processInstanceShown`、`processInstanceHidden`
- `updateElement(s)`、`animationCreated`

这些常量可直接引用，避免手写字符串。 【F:lib/util/EventHelper.js†L1-L17】

### 2.2 常用工具

- `ElementHelper` 提供类型判断、事件定义检测、祖先/后代查询以及受支持的 BPMN 元素枚举，可用于二次开发时的节点过滤与遍历。 【F:lib/util/ElementHelper.js†L1-L67】【F:lib/util/ElementHelper.js†L69-L107】
- `GeometryUtil` 仅暴露 `getMid` 与 `distance`，主要在动画路径计算中使用。 【F:lib/util/GeometryUtil.js†L1-L11】

## 3. 核心运行时服务

### 3.1 Animation

`Animation` 服务围绕 SVG 绘制流程令牌，核心 API 包括：

- 初始化时在 `import.done` 事件中创建 `#token-simulation` 容器，并监听终止、完成、重置、暂停、播放等事件以统一管理动画生命周期。 【F:lib/animation/Animation.js†L38-L115】
- `createAnimation(connection, processInstanceId, done)`：根据连接的 waypoints 生成圆形令牌，按当前速度播放并在完成时执行回调。 【F:lib/animation/Animation.js†L117-L159】
- `setAnimationSpeed(speed)`：立即调整所有正在运行的动画速度，同时更新默认速度。 【F:lib/animation/Animation.js†L161-L167】
- `showProcessInstanceAnimations` / `hideProcessInstanceAnimations`：按流程实例 ID 控制令牌的可见性，供实例切换面板调用。 【F:lib/animation/Animation.js†L189-L209】

在自定义场景中，可获取该服务以实现批量暂停、过滤动画等操作。

### 3.2 流程实例仓库

- `ProcessInstanceIds` 持续递增流程实例编号，并在切换模式或重置时归零。 【F:lib/features/process-instance-ids/ProcessInstanceIds.js†L3-L25】
- `ProcessInstances` 维护实例数组，提供 `create`、`finish`、`remove`、`getProcessInstances`/`getProcessInstance` 等方法，并在创建、完成时发出相应事件。 【F:lib/features/process-instances/ProcessInstances.js†L3-L97】
- `ProcessInstanceSettings` 负责同步动画层的显隐状态、记录当前展示的实例，并在实例切换或退出模拟时清理标记。 `showProcessInstance`/`hideProcessInstance` 会联动动画服务与事件总线。 【F:lib/features/process-instance-settings/ProcessInstanceSettings.js†L12-L122】

### 3.3 SimulationState

`SimulationState` 用于检测流程状态并记录完成情况：

- `isDeadlock()` 会扫描仍持有令牌的节点，检测无出边、并行网关等待、以及终止事件路径，必要时写日志并生成元素警告。 【F:lib/features/simulation-state/SimulationState.js†L37-L111】
- `isFinished(element, processInstanceId)` 确认父节点下无剩余令牌及动画后，记录流程/子流程完成并触发成功提示。 【F:lib/features/simulation-state/SimulationState.js†L113-L159】

该服务默认未自动调用死锁检测，可在自定义插件中订阅 `consumeToken` 并手动调用。

## 4. 界面与交互特性

### 4.1 模式切换与只读控制

- `ToggleMode` 在画布右上角插入开关，切换时更新容器 CSS、隐藏原生 palette，并触发 `toggleMode` 事件；退出时恢复选中元素的上下文菜单。 【F:lib/features/toggle-mode/modeler/ToggleMode.js†L11-L69】
- `DisableModeling` 监听同一事件，将建模相关 API 包裹成只读模式，阻止拖拽、直接编辑及各种建模命令，确保模拟期间模型保持不变。 【F:lib/features/disable-modeling/DisableModeling.js†L23-L136】

### 4.2 控制面板与命令

- `Palette` 在模拟模式激活时显示自定义面板，并按照索引插入各个条目。 【F:lib/features/palette/Palette.js†L9-L50】
- `PauseSimulation` 向 palette 添加“播放/暂停”按钮：首次流程启动会自动激活；点击时广播 `playSimulation`/`pauseSimulation` 并更新画布态。 【F:lib/features/pause-simulation/PauseSimulation.js†L18-L130】
- `ResetSimulation` 在任意开始事件触发后解锁，执行时清空全部 `tokenCount` 并广播 `resetSimulation`，退出模拟模式也会强制重置。 【F:lib/features/reset-simulation/ResetSimulation.js†L14-L67】
- `SetAnimationSpeed` 渲染三档速度按钮，调用动画服务的 `setAnimationSpeed`。 【F:lib/features/set-animation-speed/SetAnimationSpeed.js†L11-L78】
- `Log` 以侧栏形式展示运行记录，并同步投递系统通知；palette 中的“对齐”图标用于显隐。 【F:lib/features/log/Log.js†L24-L214】
- `Notifications` 负责全局吐司提示，退出模拟时会自动清空。 【F:lib/features/notifications/Notifications.js†L5-L73】

### 4.3 视觉反馈

- `ElementNotifications` 在元素上方显示告警/成功提示，切换模式或生成令牌时会清理，便于外部复用。 【F:lib/features/element-notifications/ElementNotifications.js†L5-L83】
- `TokenCount` 根据当前展示的流程实例，在元素下方覆盖令牌计数，处理终止、重置、实例切换等情况。 【F:lib/features/token-count/TokenCount.js†L1-L149】
- `ElementSupport` 在启动模拟前校验流程是否包含不支持的元素，若发现问题会在画布加警告样式并生成提示条。 【F:lib/features/element-support/ElementSupport.js†L3-L107】
- `PreserveElementColors` 进入模拟模式时强制将元素配色置为黑白，退出后恢复原值，避免动画期间颜色冲突。 【F:lib/features/preserve-element-colors/PreserveElementColors.js†L3-L63】
- `ShowProcessInstance` 渲染实例列表面板，可点击切换当前可视实例、悬停时高亮对应子流程，并在重置或退出时清空。 【F:lib/features/show-process-instance/ShowProcessInstance.js†L24-L200】

## 5. 上下文操作（Context Pads）

`ContextPads` 服务在模拟模式中扫描元素并按类型调用 handler 生成操作按钮，支持在模式切换、实例切换、元素更新时动态刷新。 【F:lib/features/context-pads/ContextPads.js†L25-L200】

内置 handler 说明：

| Handler | 适用元素 | 功能 |
| --- | --- | --- |
| `StartEventHandler` | 开始事件 | 当画布无活动令牌时允许手动触发 `generateToken`，并刷新全部开始事件的上下文。 【F:lib/features/context-pads/handler/StartEventHandler.js†L17-L49】
| `ExclusiveGatewayHandler` | 互斥网关 | 在至少两条外出流时提供分支切换，调用 `ExclusiveGatewaySettings.setSequenceFlow`。 【F:lib/features/context-pads/handler/ExclusiveGatewayHandler.js†L12-L33】【F:lib/features/exclusive-gateway-settings/ExclusiveGatewaySettings.js†L1-L86】
| `IntermediateCatchEventHandler` | 中间捕获事件 | 若自身或上游事件网关持有令牌，允许手动触发继续流转，并在触发后回写计数。 【F:lib/features/context-pads/handler/IntermediateCatchEventHandler.js†L15-L76】
| `BoundaryEventHandler` | 边界事件所在子流程 | 针对每个附着事件生成按钮，触发后按需终止宿主并将令牌交给父流程。 【F:lib/features/context-pads/handler/BoundaryEventHandler.js†L12-L88】
| `ProcessHandler` | 子流程、池 | 当存在多个实例时循环展示不同实例。 【F:lib/features/context-pads/handler/ProcessHandler.js†L14-L37】

## 6. 令牌行为处理器

`TokenSimulationBehavior` 将 `generateToken` 与 `consumeToken` 事件分派给各元素的专用 handler，所有 handler 通过 Injector 实例化，可按需扩展或替换。 【F:lib/features/token-simulation-behavior/TokenSimulationBehavior.js†L3-L83】

| Handler | `consume` 行为 | `generate` 行为 |
| --- | --- | --- |
| `StartEventHandler` | 无操作（开始事件没有入边）。 | 创建新流程实例并为所有外出顺序流生成动画，支持父子流程 ID 传递。 【F:lib/features/token-simulation-behavior/handler/StartEventHandler.js†L16-L65】 |
| `TaskHandler` | 立即重新触发自身的 `generateToken`，实现活动完成后继续流转。 | 为所有外出顺序流创建动画，动画结束时触发目标元素消费。 【F:lib/features/token-simulation-behavior/handler/TaskHandler.js†L14-L38】 |
| `ExclusiveGatewayHandler` | 校验已配置出口，随后触发 `generateToken`。 | 对当前选中的顺序流执行动画并推动目标。 【F:lib/features/token-simulation-behavior/handler/ExclusiveGatewayHandler.js†L13-L43】 |
| `EventBasedGatewayHandler` | 统计捕获事件的令牌数量并刷新上下文菜单。 | 不生成动画，由捕获事件完成。 【F:lib/features/token-simulation-behavior/handler/EventBasedGatewayHandler.js†L3-L43】 |
| `ParallelGatewayHandler` | 为每个入边累计令牌，收齐后触发下一步并清空计数。 | 将令牌并行发送给全部外出顺序流。 【F:lib/features/token-simulation-behavior/handler/ParallelGatewayHandler.js†L14-L55】 |
| `IntermediateCatchEventHandler` | 记录令牌数量并触发元素刷新。 | 将令牌传递给所有外出顺序流，并刷新同层捕获事件状态。 【F:lib/features/token-simulation-behavior/handler/IntermediateCatchEventHandler.js†L17-L65】 |
| `IntermediateThrowEventHandler` | 直接触发自身的 `generateToken`。 | 以无实例上下文的方式继续传播（可根据需要扩展 processInstanceId 支持）。 【F:lib/features/token-simulation-behavior/handler/IntermediateThrowEventHandler.js†L13-L36】 |
| `BoundaryEventHandler` | 为附着事件累计计数并刷新显示。 | 将令牌送往所有外出顺序流。 【F:lib/features/token-simulation-behavior/handler/BoundaryEventHandler.js†L16-L53】 |
| `SubProcessHandler` | 若缺少开始事件则跳过子流程，否则以当前实例作为父 ID 启动子流程，并记录日志。 | 子流程完成后将令牌传出，同时刷新元素状态。 【F:lib/features/token-simulation-behavior/handler/SubProcessHandler.js†L16-L66】 |
| `EndEventHandler` | 处理终止事件、标记流程完成，并在必要时把令牌返还至父流程开始事件。 | 不产生动画。 【F:lib/features/token-simulation-behavior/handler/EndEventHandler.js†L24-L73】 |

> 提示：若需要自定义行为，可在外部模块中 `injector.invoke` 原 handler，并覆写 `generate/consume` 方法。

## 7. 编辑器动作与快捷键

- `EditorActions` 向 bpmn-js `editorActions` 注册四个别名，可通过应用层 UI 或命令面板触发：切换模式、播放/暂停、重置、切换日志。 【F:lib/features/editor-actions/EditorActions.js†L3-L33】
- `KeyboardBindings` 在模拟模式开启后启用快捷键：`T` 切换模式、`Space` 播放/暂停、`R` 重置、`L` 切换日志；退出模式后自动失效。 【F:lib/features/keyboard-bindings/KeyboardBindings.js†L8-L84】

## 8. 状态提示与调试建议

- `Log` 与 `Notifications` 组合可快速了解模拟流程，必要时可在事件监听器中追加自定义日志文本。
- `SimulationState.isDeadlock()` 与 `ElementSupport` 输出的警告能够辅助检查流程设计问题，建议在启动模拟前手动触发一次死锁检测以提前发现异常。 【F:lib/features/simulation-state/SimulationState.js†L37-L111】【F:lib/features/element-support/ElementSupport.js†L35-L107】
- `Animation` 暴露的 `animations` 数组可用于调试当前活动路径，例如通过 DevTools 直接检查 `window.animation.animations`。 【F:lib/animation/Animation.js†L38-L158】

通过以上 API 与模块说明，可在现有插件基础上安全地扩展界面、插入自定义处理器或与业务系统联动，实现更复杂的流程验证方案。
